# Extraction of Salt core modules

Below are some rough steps that extract an existing set of modules into an extension while preserving the Git history. Let's use the `stalekey` engine as an example.

## A module extraction example

### 1. Install the Git history filtering tool

```shell
pip install git-filter-repo
```

### 2. Clone the Salt repo and analyze its history

```shell
git clone https://github.com/saltstack/salt --single-branch
cd salt
git filter-repo --analyze
tree .git/filter-repo/analysis/
rg stalekey .git/filter-repo/analysis/path-all-sizes.txt
rg stalekey .git/filter-repo/analysis/path-deleted-sizes.txt
```

The main goal here is to find all relevant files (modules, utils, automated tests, fixtures, documentation). For the `stalekey` engine that would be:

* `salt/engines/stalekey.py` - the engine itself
* `tests/unit/engines/test_stalekey.py` - old style unit tests
* `tests/pytests/unit/engines/test_stalekey.py` - new style unit-tests that use pytest

### 3. Filter the history into a separate branch

```shell
git checkout -b filter-source
git filter-repo \
    --path salt/engines/stalekey.py \
    --path-rename salt/engines/stalekey.py:src/saltext/stalekey/engines/stalekey.py \
    --path tests/pytests/unit/engines/test_stalekey.py \
    --path tests/unit/engines/test_stalekey.py \
    --refs refs/heads/filter-source --force
```

### 4. Clean up the history

```shell
git log --name-only
git rebase -i --root
```

The main goal here is to remove the commits that do not touch any of the extracted files, and also delete the last commit that removes them. The merge commits seem to be removed automatically during the rebase.

While looking at the Git log, please note the major contributors (to add them as code authors later).

### 5. Populate the extension repo

When answering the Copier questions, choose the `engine` module type only, specify yourself as an author:

```shell
cd ..
mkdir saltext-stalekey && cd saltext-stalekey
git init
copier copy --trust https://github.com/salt-extensions/salt-extension-copier ./
```

We need to remove some boilerplate files generated by Copier:

```shell
rm -rf tests/functional tests/integration tests/unit/engines/test_stalekey.py src/saltext/stalekey/engines/stalekey_mod.py
```

And then merge the history:

```shell
git remote add repo-source ../salt
git fetch repo-source
git merge repo-source/filter-source
git remote rm repo-source
git tag | xargs git tag -d
```

### 6. Clean up and testing

Move the tests into the right location:

```shell
git mv tests/pytests/unit/engines/test_stalekey.py tests/unit/engines
rm -rf tests/pytests
```

Run the automatic fixups:

```shell
pip install git+https://github.com/saltstack/salt-rewrite
SALTEXT_NAME=stalekey salt-rewrite -F fix_saltext .
```

```shell
pip install -e ".[dev,tests,docs]"
pre-commit run -a  # make sure it is happy
git status
git add .
git commit -m 'Add extension layout'
```

Add the main authors to pyproject.toml:

```shell
vi pyproject.toml
git add pyproject.toml
git commit -m 'Add authors'
```

Try running the test suite locally until it passes, then commit and push it to run the full test suite on GitHub.

## Gotchas and considerations
### Unit test module imports

Unit tests import the modules directly. After migration, these imports
need to be adjusted, otherwise the tests will run against the modules found in Salt,
but still pass (or fail once they are removed in a future release). Example:

:::{tab} old
```python
from salt.modules import vault
```
:::

:::{tab} correct
```python
from saltext.vault.modules import vault
```
:::

### Unit test `tests.support` imports

Many unit tests in the Salt code base use an indirect import for `unittest.mock`.
Ensure you update them.

:::{tab} old
```python
from tests.support.mock import MagicMock, Mock, patch
```
:::

:::{tab} correct
```python
from unittest.mock import MagicMock, Mock, patch
```
:::

### Library dependencies

Some modules have library dependencies. Since they were included in Salt core,
which cannot possibly be shipped with every dependency,
they needed to account for the library not being present.
They typically use the following stanza to avoid a crash during import:

```python
HAS_LIBS = False

try:
    import foo
    HAS_LIBS = True
except ImportError:
    pass

__virtualname__ = "foobar"


def __virtual__():
    if HAS_LIBS:
        return __virtualname__
    return False, "Missing 'foo' library"
```

If the dependencies are all hard dependencies, you should declare them as such in your Saltext's
`pyproject.toml` (in `dependencies`) and remove the conditional loading:

```python
import foo

__virtualname__ = "foobar"


def __virtual__():
    return __virtualname__
```

Other modules can work with several, interchangeable libraries. For this case, you should at least
declare a dependency on one of the choices in your `optional-dependencies` for `tests`
in order to make the tests run.

### `__utils__`

Some Salt core modules access their utilities via the `__utils__` dunder instead of direct imports,
which ensures that the called utility function has access to Salt's global dunders.

This does not work in Salt extensions. If this is the case for your extracted set of modules,
you need to adjust the `utils` to not rely on the dunders, e.g. by passing in the required
references:

:::{tab} old

```python
# ------- salt.modules.foo ---------------
def get(entity):
    return __utils__["foo.query"](entity)
```

```python
# ------- salt.utils.foo -----------------
def query(entity):
    base_url = __opts__.get("foo_base_url", "https://foo.bar")
    profile = __salt__["config.option"]("foo_profile")
    return __utils__["http.query"](base_url, data=profile)
```
:::

:::{tab} correct
```python
# ------- saltext.foo.modules.foo -------
from saltext.foo.utils import foo


def get(entity):
    base_url = __opts__.get("foo_base_url", "https://foo.bar")
    return foo.query(base_url, entity, __salt__["config.option"])
```
```python
# ------- saltext.foo.utils.foo -------
import salt.utils.http


def query(base_url, entity, config_option):
    profile = config_option("foo_profile")
    return salt.utils.http.query(base_url, data=profile)
```
:::

### Pre-pytest tests

Not all Salt core tests have been converted to Pytest. You might need to convert them
in order to keep them running.

### Migrated tests in `tests/pytest`

All tests in Salt core that were migrated to Pytest are found in `tests/pytests`.
After a migration, this directory is replicated to the Saltext project, but
Salt extension projects assume that all tests are Pytest-based and found in `tests` directly.
To ensure everything works as expected, you should remove the `pytest` part
of the path by moving the tests one level up.

### Docs

Salt core modules are documented inline. You should consider extracting general parts of the
inline documentation into a separate topic inside the `docs/topics` directory.
